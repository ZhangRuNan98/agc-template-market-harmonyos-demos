<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å¯¹è¯æ¡†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#07C160',
                        secondary: '#E5E5EA',
                        textDark: '#303133',
                        textLight: '#808080',
                        bgLight: '#F5F5F5',
                        bgDark: '#ECECEC',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        #chatContainer {
            padding-top: 0;
        }
        .image-msg {
            max-height: 160px;
            max-width: 120px;
        }

        img {
            max-height: 160px;
            max-width: 120px;
        }

        #messageInput {
           border-radius: 1.5rem;
           background-color: #F2F2F2;
        }

        #custom-footer {
            padding-bottom: 1.75rem;
        }

        textarea:focus {
          border: none;
          outline: none;
        }
    </style>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .message-appear {
                animation: messageAppear 0.3s ease-out forwards;
            }
            @keyframes messageAppear {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .bubble-left {
                border-radius: 2px 16px 16px 16px;
            }
            .bubble-right {
                border-radius: 16px 2px 16px 16px;
            }
            .emoji-tab-active {
                color: #07C160;
                border-bottom: 2px solid #07C160;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-textDark h-screen flex flex-col overflow-hidden">
<!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
<main class="flex-1 overflow-y-auto scrollbar-hide p-4" id="chatContainer">
</main>

<!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
<footer id="custom-footer" class="bg-white border-t border-gray-200 p-3">
    <div class="flex items-center">
        <div class="relative flex-1 mx-2">
            <textarea id="messageInput" placeholder="è¾“å…¥" rows="1"
                      enterkeyhint="send" inputmode="text"
                      class="w-full rounded-lg p-2 resize-none transition-all"
            ></textarea>
        </div>

        <button class="p-2 text-gray-500 transition-colors" id="emojiBtn">
            <i class="fa fa-smile-o text-xl"></i>
        </button>

        <label for="imageUpload" class="p-2 text-gray-500 transition-colors cursor-pointer">
            <i class="fa fa-image text-xl"></i>
        </label>
        <input type="file" id="imageUpload" accept="image/*" class="hidden">
    </div>

    <!-- è¡¨æƒ…é€‰æ‹©é¢æ¿ -->
    <div id="emojiPanel" class="mt-3 p-3 bg-white rounded-lg shadow-lg hidden">
        <!-- è¡¨æƒ…åˆ†ç±»æ ‡ç­¾ -->
        <div class="flex border-b border-gray-200 mb-3 overflow-x-auto scrollbar-hide pb-2">
            <button class="emoji-tab emoji-tab-active px-3 py-1 text-sm mr-2 whitespace-nowrap" data-category="common">
                å¸¸ç”¨
            </button>
            <button class="emoji-tab px-3 py-1 text-sm mr-2 whitespace-nowrap" data-category="people">äººç‰©</button>
            <button class="emoji-tab px-3 py-1 text-sm mr-2 whitespace-nowrap" data-category="nature">è‡ªç„¶</button>
            <button class="emoji-tab px-3 py-1 text-sm mr-2 whitespace-nowrap" data-category="food">é£Ÿç‰©</button>
            <button class="emoji-tab px-3 py-1 text-sm mr-2 whitespace-nowrap" data-category="activity">æ´»åŠ¨</button>
            <button class="emoji-tab px-3 py-1 text-sm mr-2 whitespace-nowrap" data-category="travel">æ—…è¡Œ</button>
            <button class="emoji-tab px-3 py-1 text-sm mr-2 whitespace-nowrap" data-category="objects">ç‰©å“</button>
            <button class="emoji-tab px-3 py-1 text-sm mr-2 whitespace-nowrap" data-category="symbols">ç¬¦å·</button>
        </div>

        <!-- è¡¨æƒ…å†…å®¹åŒºåŸŸ -->
        <div class="emoji-container h-64 overflow-y-auto scrollbar-hide">
            <!-- å¸¸ç”¨è¡¨æƒ… -->
            <div class="emoji-category" id="emoji-common">
                <div class="grid grid-cols-8 gap-2">
                    <button class="emoji-btn" data-emoji="ğŸ˜€">ğŸ˜€</button>
                    <button class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚</button>
                    <button class="emoji-btn" data-emoji="ğŸ˜Š">ğŸ˜Š</button>
                    <button class="emoji-btn" data-emoji="ğŸ˜">ğŸ˜</button>
                    <button class="emoji-btn" data-emoji="ğŸ¤”">ğŸ¤”</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
                    <button class="emoji-btn" data-emoji="ğŸ™Œ">ğŸ™Œ</button>
                    <button class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</button>
                    <button class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
                    <button class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸</button>
                    <button class="emoji-btn" data-emoji="âœ¨">âœ¨</button>
                    <button class="emoji-btn" data-emoji="ğŸ’©">ğŸ’©</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘€">ğŸ‘€</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘‹">ğŸ‘‹</button>
                    <button class="emoji-btn" data-emoji="ğŸ¤">ğŸ¤</button>
                    <button class="emoji-btn" data-emoji="ğŸ™">ğŸ™</button>
                    <button class="emoji-btn" data-emoji="ğŸ˜">ğŸ˜</button>
                    <button class="emoji-btn" data-emoji="ğŸ¥³">ğŸ¥³</button>
                    <button class="emoji-btn" data-emoji="ğŸ¤—">ğŸ¤—</button>
                </div>
            </div>

            <!-- äººç‰©è¡¨æƒ… -->
            <div class="emoji-category hidden" id="emoji-people">
                <div class="grid grid-cols-8 gap-2">
                    <button class="emoji-btn" data-emoji="ğŸ‘©">ğŸ‘©</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘¨">ğŸ‘¨</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘§">ğŸ‘§</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘¦">ğŸ‘¦</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘µ">ğŸ‘µ</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘´">ğŸ‘´</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘±â€â™€ï¸">ğŸ‘±â€â™€ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘±">ğŸ‘±</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘¨â€âš•ï¸">ğŸ‘¨â€âš•ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘©â€âš•ï¸">ğŸ‘©â€âš•ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘¨â€ğŸŒ¾">ğŸ‘¨â€ğŸŒ¾</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘©â€ğŸŒ¾">ğŸ‘©â€ğŸŒ¾</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘¨â€ğŸ”§">ğŸ‘¨â€ğŸ”§</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘©â€ğŸ”§">ğŸ‘©â€ğŸ”§</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘¨â€ğŸ“">ğŸ‘¨â€ğŸ“</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘©â€ğŸ“">ğŸ‘©â€ğŸ“</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘¨â€âš–ï¸">ğŸ‘¨â€âš–ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘©â€âš–ï¸">ğŸ‘©â€âš–ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘¨â€âœˆï¸">ğŸ‘¨â€âœˆï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘©â€âœˆï¸">ğŸ‘©â€âœˆï¸</button>
                </div>
            </div>

            <!-- è‡ªç„¶è¡¨æƒ… -->
            <div class="emoji-category hidden" id="emoji-nature">
                <div class="grid grid-cols-8 gap-2">
                    <button class="emoji-btn" data-emoji="ğŸŒ">ğŸŒ</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ">ğŸŒ</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ™">ğŸŒ™</button>
                    <button class="emoji-btn" data-emoji="ğŸŒŸ">ğŸŒŸ</button>
                    <button class="emoji-btn" data-emoji="â˜ï¸">â˜ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ§ï¸">ğŸŒ§ï¸</button>
                    <button class="emoji-btn" data-emoji="â„ï¸">â„ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
                    <button class="emoji-btn" data-emoji="ğŸ’¨">ğŸ’¨</button>
                    <button class="emoji-btn" data-emoji="ğŸŒŠ">ğŸŒŠ</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ">ğŸŒ</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ‹">ğŸŒ‹</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ²">ğŸŒ²</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ³">ğŸŒ³</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ´">ğŸŒ´</button>
                    <button class="emoji-btn" data-emoji="ğŸŒµ">ğŸŒµ</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ¼">ğŸŒ¼</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ¸">ğŸŒ¸</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ·">ğŸŒ·</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ¹">ğŸŒ¹</button>
                </div>
            </div>

            <!-- é£Ÿç‰©è¡¨æƒ… -->
            <div class="emoji-category hidden" id="emoji-food">
                <div class="grid grid-cols-8 gap-2">
                    <button class="emoji-btn" data-emoji="ğŸ">ğŸ</button>
                    <button class="emoji-btn" data-emoji="ğŸ">ğŸ</button>
                    <button class="emoji-btn" data-emoji="ğŸŠ">ğŸŠ</button>
                    <button class="emoji-btn" data-emoji="ğŸ‹">ğŸ‹</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ">ğŸŒ</button>
                    <button class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</button>
                    <button class="emoji-btn" data-emoji="ğŸ‡">ğŸ‡</button>
                    <button class="emoji-btn" data-emoji="ğŸ“">ğŸ“</button>
                    <button class="emoji-btn" data-emoji="ğŸˆ">ğŸˆ</button>
                    <button class="emoji-btn" data-emoji="ğŸ’">ğŸ’</button>
                    <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
                    <button class="emoji-btn" data-emoji="ğŸ">ğŸ</button>
                    <button class="emoji-btn" data-emoji="ğŸ¥­">ğŸ¥­</button>
                    <button class="emoji-btn" data-emoji="ğŸ…">ğŸ…</button>
                    <button class="emoji-btn" data-emoji="ğŸ¥">ğŸ¥</button>
                    <button class="emoji-btn" data-emoji="ğŸ†">ğŸ†</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ¶ï¸">ğŸŒ¶ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ¥”">ğŸ¥”</button>
                    <button class="emoji-btn" data-emoji="ğŸ¥•">ğŸ¥•</button>
                    <button class="emoji-btn" data-emoji="ğŸŒ½">ğŸŒ½</button>
                </div>
            </div>

            <!-- æ´»åŠ¨è¡¨æƒ… -->
            <div class="emoji-category hidden" id="emoji-activity">
                <div class="grid grid-cols-8 gap-2">
                    <button class="emoji-btn" data-emoji="âš½">âš½</button>
                    <button class="emoji-btn" data-emoji="ğŸ€">ğŸ€</button>
                    <button class="emoji-btn" data-emoji="ğŸˆ">ğŸˆ</button>
                    <button class="emoji-btn" data-emoji="âš¾">âš¾</button>
                    <button class="emoji-btn" data-emoji="ğŸ¾">ğŸ¾</button>
                    <button class="emoji-btn" data-emoji="ğŸ">ğŸ</button>
                    <button class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</button>
                    <button class="emoji-btn" data-emoji="ğŸ±">ğŸ±</button>
                    <button class="emoji-btn" data-emoji="ğŸ“">ğŸ“</button>
                    <button class="emoji-btn" data-emoji="ğŸ¸">ğŸ¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ¥Š">ğŸ¥Š</button>
                    <button class="emoji-btn" data-emoji="ğŸ¥‹">ğŸ¥‹</button>
                    <button class="emoji-btn" data-emoji="ğŸ¹">ğŸ¹</button>
                    <button class="emoji-btn" data-emoji="â›·ï¸">â›·ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ‚">ğŸ‚</button>
                    <button class="emoji-btn" data-emoji="ğŸ¿">ğŸ¿</button>
                    <button class="emoji-btn" data-emoji="ğŸŠ">ğŸŠ</button>
                    <button class="emoji-btn" data-emoji="ğŸŠâ€â™€ï¸">ğŸŠâ€â™€ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸš´">ğŸš´</button>
                    <button class="emoji-btn" data-emoji="ğŸš´â€â™€ï¸">ğŸš´â€â™€ï¸</button>
                </div>
            </div>

            <!-- æ—…è¡Œè¡¨æƒ… -->
            <div class="emoji-category hidden" id="emoji-travel">
                <div class="grid grid-cols-8 gap-2">
                    <button class="emoji-btn" data-emoji="âœˆï¸">âœˆï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸš€">ğŸš€</button>
                    <button class="emoji-btn" data-emoji="â›µ">â›µ</button>
                    <button class="emoji-btn" data-emoji="ğŸš¢">ğŸš¢</button>
                    <button class="emoji-btn" data-emoji="ğŸš‚">ğŸš‚</button>
                    <button class="emoji-btn" data-emoji="ğŸš„">ğŸš„</button>
                    <button class="emoji-btn" data-emoji="ğŸš—">ğŸš—</button>
                    <button class="emoji-btn" data-emoji="ğŸš™">ğŸš™</button>
                    <button class="emoji-btn" data-emoji="ğŸšŒ">ğŸšŒ</button>
                    <button class="emoji-btn" data-emoji="ğŸš">ğŸš</button>
                    <button class="emoji-btn" data-emoji="ğŸš‘">ğŸš‘</button>
                    <button class="emoji-btn" data-emoji="ğŸš“">ğŸš“</button>
                    <button class="emoji-btn" data-emoji="ğŸš’">ğŸš’</button>
                    <button class="emoji-btn" data-emoji="ğŸš">ğŸš</button>
                    <button class="emoji-btn" data-emoji="ğŸšš">ğŸšš</button>
                    <button class="emoji-btn" data-emoji="ğŸš›">ğŸš›</button>
                    <button class="emoji-btn" data-emoji="ğŸšœ">ğŸšœ</button>
                    <button class="emoji-btn" data-emoji="ğŸ›µ">ğŸ›µ</button>
                    <button class="emoji-btn" data-emoji="ğŸš²">ğŸš²</button>
                    <button class="emoji-btn" data-emoji="ğŸ›º">ğŸ›º</button>
                </div>
            </div>

            <!-- ç‰©å“è¡¨æƒ… -->
            <div class="emoji-category hidden" id="emoji-objects">
                <div class="grid grid-cols-8 gap-2">
                    <button class="emoji-btn" data-emoji="ğŸ“±">ğŸ“±</button>
                    <button class="emoji-btn" data-emoji="ğŸ’»">ğŸ’»</button>
                    <button class="emoji-btn" data-emoji="âŒš">âŒš</button>
                    <button class="emoji-btn" data-emoji="ğŸ“º">ğŸ“º</button>
                    <button class="emoji-btn" data-emoji="ğŸ“·">ğŸ“·</button>
                    <button class="emoji-btn" data-emoji="ğŸ“¸">ğŸ“¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ”¦">ğŸ”¦</button>
                    <button class="emoji-btn" data-emoji="ğŸ”Œ">ğŸ”Œ</button>
                    <button class="emoji-btn" data-emoji="ğŸ’¡">ğŸ’¡</button>
                    <button class="emoji-btn" data-emoji="ğŸ”¦">ğŸ”¦</button>
                    <button class="emoji-btn" data-emoji="ğŸ”‹">ğŸ”‹</button>
                    <button class="emoji-btn" data-emoji="ğŸ”Œ">ğŸ”Œ</button>
                    <button class="emoji-btn" data-emoji="ğŸ”">ğŸ”</button>
                    <button class="emoji-btn" data-emoji="ğŸ”’">ğŸ”’</button>
                    <button class="emoji-btn" data-emoji="ğŸ”“">ğŸ”“</button>
                    <button class="emoji-btn" data-emoji="ğŸ”‘">ğŸ”‘</button>
                    <button class="emoji-btn" data-emoji="ğŸ”¨">ğŸ”¨</button>
                    <button class="emoji-btn" data-emoji="ğŸ”§">ğŸ”§</button>
                    <button class="emoji-btn" data-emoji="âš™ï¸">âš™ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ”©">ğŸ”©</button>
                </div>
            </div>

            <!-- ç¬¦å·è¡¨æƒ… -->
            <div class="emoji-category hidden" id="emoji-symbols">
                <div class="grid grid-cols-8 gap-2">
                    <button class="emoji-btn" data-emoji="â¤">â¤</button>
                    <button class="emoji-btn" data-emoji="ğŸ’›">ğŸ’›</button>
                    <button class="emoji-btn" data-emoji="ğŸ’š">ğŸ’š</button>
                    <button class="emoji-btn" data-emoji="ğŸ’™">ğŸ’™</button>
                    <button class="emoji-btn" data-emoji="ğŸ’œ">ğŸ’œ</button>
                    <button class="emoji-btn" data-emoji="ğŸ–¤">ğŸ–¤</button>
                    <button class="emoji-btn" data-emoji="ğŸ¤">ğŸ¤</button>
                    <button class="emoji-btn" data-emoji="ğŸ¤">ğŸ¤</button>
                    <button class="emoji-btn" data-emoji="ğŸ’•">ğŸ’•</button>
                    <button class="emoji-btn" data-emoji="ğŸ’">ğŸ’</button>
                    <button class="emoji-btn" data-emoji="ğŸ’“">ğŸ’“</button>
                    <button class="emoji-btn" data-emoji="ğŸ’—">ğŸ’—</button>
                    <button class="emoji-btn" data-emoji="ğŸ’–">ğŸ’–</button>
                    <button class="emoji-btn" data-emoji="ğŸ’">ğŸ’</button>
                    <button class="emoji-btn" data-emoji="ğŸ’˜">ğŸ’˜</button>
                    <button class="emoji-btn" data-emoji="ğŸ’¯">ğŸ’¯</button>
                    <button class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
                    <button class="emoji-btn" data-emoji="âœ¨">âœ¨</button>
                    <button class="emoji-btn" data-emoji="â„ï¸">â„ï¸</button>
                    <button class="emoji-btn" data-emoji="ğŸ’§">ğŸ’§</button>
                </div>
            </div>
        </div>
    </div>
</footer>

<script>
    // ä½¿ç”¨æ›´å¯é çš„æ–¹å¼åˆ‡æ¢è¡¨æƒ…é¢æ¿
    let isEmojiPanelOpen = false;

    // DOM å…ƒç´ 
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const imageUpload = document.getElementById('imageUpload');
    const emojiBtns = document.querySelectorAll('.emoji-btn');
    const emojiTabs = document.querySelectorAll('.emoji-tab');
    const emojiCategories = document.querySelectorAll('.emoji-category');

    // åˆå§‹åŒ–æ•°æ®
    let myAvatar = '';
    let otherAvatar = '';
    let messages = [];

    queryAllInfo();

    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight > 120 ? 120 : this.scrollHeight) + 'px';
    });

    // æŸ¥è¯¢ä¿¡æ¯
    function queryAllInfo() {
        console.log('queryAllInfo');
        msgIMChatViewModel.queryList().then((resp) => {
            console.log('queryAllInfo resp: '+ JSON.stringify(resp));
            myAvatar = resp.myAvatar;
            otherAvatar = resp.otherAvatar;
            messages = resp.messages;
            // åˆå§‹åŒ–æ˜¾ç¤ºæ¶ˆæ¯
            messages.forEach(message => {
                appendMessage(message.content, message.type, message.isMyself, message.createTime);
            });
        })
    }

    // æ¨¡æ‹Ÿå¯¹æ–¹å›å¤
    function mockReply() {
        setTimeout(() => {
            const reply = {
                type: 'text',
                content: 'æ„Ÿè°¢ä½ çš„æ¶ˆæ¯ï¼',
            };
            appendMessage(reply.content, reply.type, false);
        }, 1000);
    }

    // å‘é€æ–‡å­—æ¶ˆæ¯
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            appendMessage(message, 'text', true);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            msgIMChatViewModel.sendMessage(message, 'text');
            mockReply();
        }
    }

    // å‘é€å›¾ç‰‡æ¶ˆæ¯
    imageUpload.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const createTime = new Date().getTime();
                appendMessage(e.target.result, 'image', true, createTime);
                msgIMChatViewModel.sendMessage(e.target.result, 'image', createTime);
                mockReply();
            };
            reader.readAsDataURL(this.files[0]);
            this.value = ''; // é‡ç½®è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        }
    });

    // è¿½åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
    function appendMessage(content, type, isMyself, createTime) {
        if (type === 'time') {
            showTime(content);
        } else if (isMyself) {
            showMyMessage(content, type, createTime);
        } else {
            showTAMessage(content, type, createTime);
        }
    }

    // æ˜¾ç¤ºæ—¶é—´
    function showTime(content) {
        let messageHtml = `
            <div class="flex justify-center my-4">
                <span class="bg-gray-200 text-xs text-textLight px-3 py-1 rounded-full">
                    ${escapeHTML(content)}
                </span>
            </div>
        `;

        chatContainer.insertAdjacentHTML('beforeend', messageHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // è‡ªå·±çš„æ¶ˆæ¯
    function showMyMessage(content, type, createTime) {
        let messageHtml = '';

        if (type === 'text') {
            messageHtml = `
                <div class="flex items-start justify-end mb-4 message-appear">
                    <div class="mr-3 max-w-[70%]">
                        <div class="bg-white p-3 bubble-right shadow-sm">
                            <p>${escapeHTML(content)}</p>
                        </div>
                    </div>
                    <img src="${myAvatar}"
                        alt="è‡ªå·±å¤´åƒ"
                        class="my-avatar w-10 h-10 rounded-full object-cover"
                        onclick="msgIMChatViewModel.jumpMyProfile()"
                    >
                </div>
            `;
        } else if (type === 'image') {
            messageHtml = `
                <div class="flex items-start justify-end mb-4 message-appear">
                    <div class="mr-3 max-w-[70%]">
                        <div class="bubble-right shadow-sm">
                            <img src="${content}"
                                alt="è‡ªå·±å‘é€çš„å›¾ç‰‡"
                                class="send-image rounded-lg max-w-full"
                                onclick="msgIMChatViewModel.enterPreview('${content}', ${createTime})"
                            >
                        </div>
                    </div>
                    <img src="${myAvatar}" alt="è‡ªå·±å¤´åƒ" class="my-avatar w-10 h-10 rounded-full object-cover"
                    onclick="msgIMChatViewModel.jumpMyProfile()"
                    >
                </div>
            `;
        }

        chatContainer.insertAdjacentHTML('beforeend', messageHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // å¯¹é¢çš„æ¶ˆæ¯
    function showTAMessage(content, type, createTime) {
        let messageHtml = '';

        if (type === 'text') {
            messageHtml = `
                <div class="flex items-start mb-4 message-appear">
                    <img src="${otherAvatar}"
                        alt="å¯¹æ–¹å¤´åƒ"
                        class="other-avatar w-10 h-10 rounded-full object-cover"
                        onclick="msgIMChatViewModel.jumpTAProfile()"
                    >
                    <div class="ml-3 max-w-[70%]">
                        <div class="bg-white p-3 bubble-left shadow-sm">
                            <p>${escapeHTML(content)}</p>
                        </div>
                    </div>
                </div>
            `;
        } else if (type === 'image') {
            messageHtml = `
                 <div class="flex items-start mb-4 message-appear">
                    <img src="${otherAvatar}" alt="å¯¹æ–¹å¤´åƒ" class="other-avatar w-10 h-10 rounded-full object-cover"
                    onclick="msgIMChatViewModel.jumpTAProfile()"
                    >
                    <div class="ml-3 max-w-[70%]">
                        <div class="bubble-left shadow-sm">
                            <img src="${content}"
                                alt="å¯¹æ–¹å‘é€çš„å›¾ç‰‡"
                                class="send-image rounded-lg image-msg"
                                onclick="msgIMChatViewModel.enterPreview('${content}', ${createTime})"
                            >
                        </div>
                    </div>
                </div>
            `;
        }

        chatContainer.insertAdjacentHTML('beforeend', messageHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
    function escapeHTML(str) {
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // ä¼˜åŒ–åçš„åˆ‡æ¢å‡½æ•°
    function toggleEmojiPanel() {
        isEmojiPanelOpen = !isEmojiPanelOpen;

        // ç¡®ä¿è¾“å…¥æ¡†è·å¾—/å¤±å»ç„¦ç‚¹
        if (isEmojiPanelOpen) {
            messageInput.blur(); // éšè—é”®ç›˜
        }

        setTimeout(() => {
         emojiPanel.classList.toggle('hidden', !isEmojiPanelOpen);
        }, 200)

        // æ·»åŠ åŠ¨ç”»ç±»ä»¥ç¡®ä¿è¿‡æ¸¡æ•ˆæœ
        if (isEmojiPanelOpen) {
            emojiPanel.classList.add('animate-fade-in');
        } else {
            emojiPanel.classList.remove('animate-fade-in');
        }
    }

    // è¡¨æƒ…é€‰æ‹©é¢æ¿åˆ‡æ¢
    emojiBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleEmojiPanel()
    });

    // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­è¡¨æƒ…é¢æ¿
    document.addEventListener('click', function(event) {
        if (isEmojiPanelOpen && !emojiPanel.contains(event.target) && event.target !== emojiBtn) {
            isEmojiPanelOpen = false;
            emojiPanel.classList.add('hidden');
        }
    });

    // å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œæé«˜ç§»åŠ¨ç«¯å“åº”é€Ÿåº¦
    emojiBtn.addEventListener('touchstart', function(e) {
        e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        e.stopPropagation();
        toggleEmojiPanel();
    }, { passive: false });

    // æ·»åŠ CSSåŠ¨ç”»æ”¯æŒ
    const style = document.createElement('style');
    style.textContent = `
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);

    // é€‰æ‹©è¡¨æƒ…
    emojiBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const emoji = this.getAttribute('data-emoji');
            messageInput.value = messageInput.value + emoji;
        });
    });

    // è¡¨æƒ…åˆ†ç±»åˆ‡æ¢
    emojiTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const category = this.getAttribute('data-category');

            // æ›´æ–°æ ‡ç­¾æ ·å¼
            emojiTabs.forEach(t => t.classList.remove('emoji-tab-active'));
            this.classList.add('emoji-tab-active');

            // æ˜¾ç¤ºå¯¹åº”åˆ†ç±»
            emojiCategories.forEach(cat => {
                cat.classList.add('hidden');
            });
            document.getElementById(`emoji-${category}`).classList.remove('hidden');
        });
    });

    // ç»‘å®šå‘é€æŒ‰é’®å’Œå›è½¦äº‹ä»¶
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
</body>
</html>
