import { LoginSheetUtils } from 'lib_account';
import { BaseViewModel, FormatCount } from 'lib_common';
import { BaseNewsServiceApi, CommentServiceApi, MineServiceApi, NewsResponse } from 'lib_news_api';

@ObservedV2
export class SideBarVM extends BaseViewModel {
  @Trace videoInfo: NewsResponse = {} as NewsResponse

  isFollow() {
    return this.userInfoModel.watchers.includes(this.videoInfo.author.authorId)
  }
  // 关注操作
  followOperation() {
    if (!this.userInfoModel.isLogin) {
      LoginSheetUtils.open()
      return
    }
    if (!this.isFollow()) {
      this.follow()
      return
    }
    this.unfollow()
  }

  follow() {
    let authorId = this.videoInfo.author.authorId
    this.userInfoModel.watchers.push(authorId)
    MineServiceApi.addWatch(authorId)
  }

  unfollow() {
    let watchIndex = this.userInfoModel.watchers.findIndex(v => v === this.videoInfo.author.authorId)
    this.userInfoModel.watchers.splice(watchIndex, 1)
    MineServiceApi.cancelWatch(this.videoInfo.author.authorId)
  }

  handlerCoverImage(newsDetails: NewsResponse): string {
    return newsDetails.coverUrl || ''
  }

  // 点赞数
  getLikeCount(): string {
    if (!this.videoInfo.likeCount) {
      return '点赞'
    }
    return FormatCount.formatNumberToW(this.videoInfo.likeCount)
  }

  // 点赞操作
  likeAction() {
    this.videoInfo.isLiked = !this.videoInfo.isLiked;
    if (this.videoInfo.isLiked) {
      CommentServiceApi.addPosterLike(this.videoInfo.id)
      MineServiceApi.addLike(this.videoInfo.id)
      this.videoInfo.likeCount++
      return
    }
    CommentServiceApi.cancelPosterLike(this.videoInfo.id)
    MineServiceApi.cancelLike(this.videoInfo.id)
    this.videoInfo.likeCount--
  }

  // 收藏数
  getMarkCount(): string {
    if (!this.videoInfo.markCount) {
      return '收藏'
    }
    return FormatCount.formatNumberToW(this.videoInfo.markCount)
  }

  // 收藏操作
  saveAction() {
    if (!this.userInfoModel.isLogin) {
      LoginSheetUtils.open()
      return
    }

    this.videoInfo.isMarked = !this.videoInfo.isMarked
    if (this.videoInfo.isMarked) {
      BaseNewsServiceApi.addMark(this.videoInfo.id)
      MineServiceApi.addMark(this.videoInfo.id)
      this.videoInfo.markCount++
      return
    }
    BaseNewsServiceApi.cancelMark(this.videoInfo.id)
    MineServiceApi.cancelMark(this.videoInfo.id)
    this.videoInfo.markCount--
  }
}